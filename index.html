<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nowenna rozwiązująca węzły — interaktywnie (9 dni)</title>
<style>
  :root{
    --bg: #f3f6ff;
    --panel: #ffffff;
    --panel-2:#eef2ff;
    --text:#0e1533;
    --muted:#6370a0;
    --accent:#2450ff;
    --accent-2:#6ea8ff;
    --ring:#2450ff22;
    --ok:#2563eb;        /* niebieski wypełnienia */
    --ok-strong:#1d4ed8; /* ciemniejsza ramka */
    --soft:#e8edff;
    --chip:#dbe5ff;
  }
  .dark{
    --bg:#0f1221;
    --panel:#161a2f;
    --panel-2:#1a1f3a;
    --text:#e8edff;
    --muted:#a7b1e6;
    --accent:#8ea0ff;
    --accent-2:#6ea8ff;
    --ring:#8ea0ff33;
    --ok:#8ea0ff;
    --ok-strong:#b2c2ff;
    --soft:#20254a;
    --chip:#272f63;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:800px; margin:0 auto; padding:18px;}
  header{display:block; margin-bottom:14px}
  .banner{background:linear-gradient(180deg,#cfe3ff,#e9f0ff); color:#0b2a55; border-radius:18px; padding:18px; text-align:center; box-shadow:0 8px 24px #0001; border:1px solid #ffffff70; margin-bottom:12px}
  .banner h1{margin:0; font-size:clamp(22px,4.5vw,32px); font-weight:800; letter-spacing:.2px}
  .controlbar{display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; position:relative}
  .menu{position:absolute; top:100%; margin-top:8px; background:var(--panel); border:1px solid #00000015; box-shadow:0 14px 40px #0003; border-radius:14px; padding:8px; min-width:220px; max-width:280px; z-index:50; display:none}
  .menu.show{display:block}
  .menu h4{margin:6px 8px 8px; font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.2px}
  .menu .item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-radius:10px; cursor:pointer}
  .menu .item:hover{background:var(--soft)}
  .menu .item .meta{font-size:11px; color:var(--muted)}
  .menu .del{border:none; background:#f1f3ff; color:#1a2a7a; border-radius:8px; padding:6px 8px; cursor:pointer}
  .menu .empty{padding:10px; font-size:12px; color:var(--muted)}
  .controls{display:flex; gap:8px; align-items:center;}
  .field{display:flex; gap:8px; align-items:center; background:var(--panel); border:1px solid #00000010; padding:6px 8px; border-radius:12px}
  .field input{border:none; outline:none; background:transparent; color:var(--text); font-size:14px; padding:6px; width:150px}
  @media (max-width:560px){
    .field input{width:120px}
  }
  .title{font-weight:800; letter-spacing:.2px; font-size:clamp(18px,3vw,24px)}
  .chip{background:var(--chip); border:1px solid #ffffff10; padding:8px 10px; border-radius:12px; font-size:13px}
  .btn{border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700; letter-spacing:.2px}
  .toggle{background:var(--panel); border:1px solid #00000010; box-shadow:0 4px 14px #0002;}
  .square{width:40px; height:40px; padding:0; display:grid; place-items:center; background:#e7ebff; color:#1a2a7a}
  .square.active{background:#1a2a7a; color:#e7ebff}
  .start{background:linear-gradient(180deg, #35b86b, #2ea45f); color:white}

  .card{background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid #ffffff12; border-radius:18px; padding:18px; box-shadow:0 10px 30px #0003}

  .content{min-height:120px; padding:14px; border-radius:14px; background:var(--soft); border:1px solid #ffffff22; line-height:1.5}
  .meta{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px; font-size:13px; color:var(--muted)}

  /* Dół: przyciski + kwadraciki poziomo */
  .ctrl-bottom{display:flex; align-items:center; justify-content:center; gap:10px; margin-top:10px; flex-wrap:wrap}
  .nav-btn{border:none; border-radius:999px; padding:12px 20px; background:#2450ff; color:white; font-weight:800; letter-spacing:.3px; cursor:pointer}
  .nav-btn:disabled{opacity:.5; cursor:not-allowed}
  .nav-btn.secondary{background:#d7dcef; color:#1c275f}
  .footer{margin-top:12px; display:flex; align-items:center; justify-content:center; gap:8px; white-space:nowrap; overflow-x:auto; padding:6px 4px}
  .dot{display:inline-block; width:18px; height:18px; border-radius:4px; background:#c9d3ff; border:1px solid #9bb1ff; opacity:.9}
  .dot.done{background:var(--ok); border-color:var(--ok-strong); opacity:1}
  .dot.current{background:var(--ok); border-color:var(--ok-strong); opacity:1}

  .toast{position:fixed; inset:auto 0 22px 0; display:flex; justify-content:center; pointer-events:none}
  .toast > div{background:#101940; color:white; padding:10px 16px; border-radius:12px; box-shadow:0 10px 30px #0007; opacity:0; transform:translateY(8px)}
  .toast.show > div{opacity:1; transform:translateY(0); transition:all .25s ease}

  .hint{font-size:12px; color:var(--muted); text-align:center; margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="banner"><h1>Nowenna rozwiązująca węzły</h1></div>
      <div class="controlbar">
        <button id="themeBtn" class="btn toggle" title="Tryb dzień / noc">🌞/🌙</button>
        <div class="field">
          <span class="chip">Imię</span>
          <input id="nameInput" type="text" placeholder="np. Ania" maxlength="24" />
          <button id="nameBtn" class="btn square" title="Wybierz zapisane imię">👤</button>
          <button id="peekBtn" class="btn square" title="Podgląd wszystkich dni (X)">✕</button>
          <button id="startBtn" class="btn start">Rozpocznij</button>
        </div>
        <div id="nameMenu" class="menu" aria-hidden="true"></div>
      </div>
    </header>

    <div class="card">
      <div id="content" class="content">Podaj imię i kliknij „Rozpocznij”, aby zacząć dzień 1.</div>
      <div class="meta">
        <div id="metaDay">Dzień –</div>
        <div id="metaStep">Krok –/–</div>
      </div>

      <div class="ctrl-bottom">
        <button id="prevBottom" class="nav-btn secondary" disabled>⟵ Wstecz</button>
        <button id="nextBottom" class="nav-btn" disabled>Dalej ⟶</button>
      </div>

      <div class="footer" id="footerDots"></div>
      <div class="hint">Kwadraciki tylko pokazują postęp (dzień i datę). Nawigacja działa w obrębie bieżącego dnia. Podgląd (✕) pozwala przejrzeć wszystkie dni bez zapisu.</div>
    </div>
  </div>

  <div class="toast" id="toast"><div id="toastMsg">—</div></div>

<script>
// ——— TREŚCI 9 DNI (przykładowe, po 3 kroki na dzień) ———
const DAYS = [
  [
    "W imię Ojca, Syna i Ducha Świętego — powierzam Ci, Panie, wszystkie węzły mojego życia.",
    "Maryjo, Matko rozwiązująca węzły — wstawiaj się za mną i ucz pokoju serca.",
    "Jezu, oddaję Tobie lęki i niepewność. Rozwiąż to, czego sam nie potrafię." 
  ],
  [
    "Panie, naucz mnie cierpliwości, gdy węzły nie rozwiązują się natychmiast.",
    "Maryjo, naucz mnie ufać, kiedy nie widzę drogi.",
    "Niech Twoja wola, Boże, prowadzi mnie przez ten dzień." 
  ],
  [
    "Zawierzam Ci relacje, w których utknąłem w nieporozumieniach.",
    "Maryjo, wlej w moje serce łagodność i cichość.",
    "Jezu, pojednaj mnie z tymi, których zraniłem i którzy zranili mnie." 
  ],
  [
    "Oddaję Ci, Panie, węzły w pracy i obowiązkach.",
    "Ucz mnie mądrości w decyzjach małych i wielkich.",
    "Niech Twoje światło rozproszy mój chaos." 
  ],
  [
    "Panie, dotknij moich lęków o przyszłość.",
    "Maryjo, przypominaj mi, że jestem w rękach Boga.",
    "Daj mi serce wdzięczne za to, co już rozwiązane." 
  ],
  [
    "Zawierzam Ci moje zdrowie — ciało i duszę.",
    "Maryjo, otocz opieką wszystkich chorych i strapionych.",
    "Jezu, bądź moją siłą w słabości." 
  ],
  [
    "Panie, naucz mnie przebaczać — naprawdę i do końca.",
    "Maryjo, wyproś mi łaskę pokory.",
    "Niech przebaczenie rozwiąże najtwardsze węzły." 
  ],
  [
    "Odłóż ode mnie pokusy zniechęcenia i gniewu.",
    "Maryjo, prowadź mnie drogą wytrwałości.",
    "Jezu, napełnij mnie nadzieją, która nie zawodzi." 
  ],
  [
    "Dziękuję Ci, Panie, za wszystkie łaski na tej drodze.",
    "Maryjo, naucz mnie żyć w prostocie i ufności.",
    "Zawierzam Ci owoce nowenny i proszę o pokój serca." 
  ]
];

// ——— STAN i PAMIĘĆ ———
const LS_THEME = 'nowenna_theme';
const LS_PREFIX = 'nowenna_wezly_'; // klucz per imię

const ui = {
  themeBtn: document.getElementById('themeBtn'),
  nameInput: document.getElementById('nameInput'),
  startBtn: document.getElementById('startBtn'),
  nameBtn: document.getElementById('nameBtn'),
  peekBtn: document.getElementById('peekBtn'),
  prevBottom: document.getElementById('prevBottom'),
  nextBottom: document.getElementById('nextBottom'),
  content: document.getElementById('content'),
  metaDay: document.getElementById('metaDay'),
  metaStep: document.getElementById('metaStep'),
  dotsWrap: document.getElementById('footerDots'),
  toast: document.getElementById('toast'),
  toastMsg: document.getElementById('toastMsg'),
  nameMenu: document.getElementById('nameMenu')
};

let state = {
  name: '',
  day: 1, // 1..9
  step: 0, // index kroku
  done: Array(9).fill(false),
  start_date: null, // 'YYYY-MM-DD'
  preview: false
};
let snapshot = null; // stan sprzed wejścia do podglądu

function keyFor(name){ return LS_PREFIX + name.toLowerCase().trim(); }

function save(){
  if(!state.name) return;
  if(state.preview) return; // w podglądzie nic nie zapisujemy
  localStorage.setItem(keyFor(state.name), JSON.stringify({
    display_name: state.name,
    day:state.day,
    step:state.step,
    done:state.done,
    start_date: state.start_date
  }));
}

function clearFor(name){ localStorage.removeItem(keyFor(name)); }

function load(name){
  const raw = localStorage.getItem(keyFor(name));
  if(!raw){
    state = { ...state, name, day:1, step:0, done:Array(9).fill(false), start_date: todayISO(), preview:false };
    return;
  }
  try{
    const d = JSON.parse(raw);
    state = {
      ...state,
      name: d.display_name || name,
      day: d.day||1,
      step: d.step||0,
      done: Array.isArray(d.done)? d.done.slice(0,9).concat(Array(9).fill(false)).slice(0,9) : Array(9).fill(false),
      start_date: d.start_date || todayISO(),
      preview:false
    };
  }catch(e){
    state = { ...state, name, day:1, step:0, done:Array(9).fill(false), start_date: todayISO(), preview:false };
  }
}

// ——— DATY ———
function pad(n){ return String(n).padStart(2,'0'); }
function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function todayISO(){ const d = new Date(); return toISODate(new Date(d.getFullYear(), d.getMonth(), d.getDate())); }
function parseISODate(s){ const [y,m,da] = s.split('-').map(Number); return new Date(y, m-1, da); }
function formatPL(d){ return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`; }
function addDays(base, days){ const d = new Date(base.getTime()); d.setDate(d.getDate()+days); return d; }
function dateForDay(day){ if(!state.start_date) return null; const start = parseISODate(state.start_date); return addDays(start, day-1); }

function setTheme(mode){ const root = document.documentElement; if(mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark'); localStorage.setItem(LS_THEME, mode); }
function toggleTheme(){ const isDark = document.documentElement.classList.contains('dark'); setTheme(isDark? 'light' : 'dark'); }
function initTheme(){ const saved = localStorage.getItem(LS_THEME); if(saved){ setTheme(saved); } else { const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; setTheme(prefersDark? 'dark':'light'); } }

function stepsForCurrent(){
  const base = DAYS[state.day-1];
  // Ostatnia strona (gratki) w dniu 9
  if(state.day===9){
    return [...base, "🎉 Brawo! Ukończyłeś całą nowennę. Wciśnij Reset i rozpocznij od nowa."];
  }
  return base;
}

function isResetEligible(){
  if(!state.name) return false;
  // Pozwól na Reset także w podglądzie, jeśli jesteśmy na ostatniej stronie dnia 9
  if(state.day!==9) return false;
  const steps = stepsForCurrent();
  return state.step === steps.length - 1; // ostatnia strona dnia 9
}

function render(){
  // Teksty i meta
  if(!state.name){
    ui.content.textContent = 'Podaj imię i kliknij „Rozpocznij”, aby zacząć dzień 1.';
    ui.metaDay.textContent = 'Dzień –';
    ui.metaStep.textContent = 'Krok –/–';
  } else {
    const steps = stepsForCurrent();
    const safeStep = Math.max(0, Math.min(state.step, steps.length-1));
    state.step = safeStep;
    ui.content.textContent = steps[safeStep];
    const d = dateForDay(state.day);
    const dateStr = d ? formatPL(d) : '—';
    ui.metaDay.textContent = `Dzień ${state.day} z 9 — ${dateStr}`;
    ui.metaStep.textContent = `Krok ${safeStep+1} z ${steps.length}`;
  }

  // Dots (poziomo, bez klikania). Podświetlenie dopiero po wpisaniu imienia
  ui.dotsWrap.innerHTML = '';
  for(let i=1;i<=9;i++){
    const dot = document.createElement('div');
    dot.className = 'dot';
    if(state.name){
      if(state.done[i-1]) dot.classList.add('done');
      if(i===state.day) dot.classList.add('current');
    }
    const dt = state.name ? dateForDay(i) : null;
    dot.title = state.name && dt ? `Dzień ${i} — ${formatPL(dt)}` : `Dzień ${i}`;
    ui.dotsWrap.appendChild(dot);
  }

  // Stan przycisków nawigacji (aktywny także w podglądzie)
  const canNavigate = state.name || state.preview;
  const steps = canNavigate ? stepsForCurrent() : null;
  const atFirst = !steps || state.step===0;
  const atLast  = !steps || state.step===steps.length-1;
  // W podglądzie pozwól "przeskoczyć" dzień: nie blokuj przycisków na granicach
  const disablePrev = !canNavigate || (atFirst && !(state.preview && state.day>1));
  const disableNext = !canNavigate || (atLast  && !(state.preview && state.day<9));
  ui.prevBottom.disabled = disablePrev;
  ui.nextBottom.disabled = disableNext;

  // Przycisk Rozpocznij/Reset — Reset tylko na ostatniej stronie dnia 9
  ui.startBtn.textContent = isResetEligible() ? 'Reset' : 'Rozpocznij';
}

function showToast(msg){ ui.toastMsg.textContent = msg; ui.toast.classList.add('show'); setTimeout(()=> ui.toast.classList.remove('show'), 2200); }

// ——— NAWIGACJA ———
function nextStep(){
  const steps = stepsForCurrent();
  if(state.preview){
    if(state.step < steps.length-1){ state.step += 1; render(); return; }
    if(state.day < 9){ state.day += 1; state.step = 0; render(); return; }
    showToast('Koniec podglądu: dzień 9.'); return;
  }
  if(!state.name) return;
  if(state.step < steps.length-1){
    state.step += 1; save(); render(); return;
  }
  // ostatni krok danego dnia
  state.done[state.day-1] = true; save(); render();
  if(state.day===9){ showToast('Brawo! Ukończyłeś całą nowennę.'); }
  else { showToast(`Ukończyłeś dzień ${state.day}.`); }
}

function prevStep(){
  if(state.preview){
    if(state.step > 0){ state.step -= 1; render(); return; }
    if(state.day > 1){ state.day -= 1; state.step = stepsForCurrent().length-1; render(); return; }
    return;
  }
  if(!state.name) return;
  if(state.step > 0){ state.step -= 1; save(); render(); }
}

// ——— ZDARZENIA ———
ui.themeBtn.addEventListener('click', toggleTheme);
ui.startBtn.addEventListener('click', ()=>{
  // RESET dostępny tylko na 9 dniu ostatniej stronie
  if(isResetEligible()){
    const prevName = state.name; if(prevName) clearFor(prevName);
    // wyłącz podgląd i zdejmij aktywność ikony X
    state.preview = false; if(ui.peekBtn) ui.peekBtn.classList.remove('active');
    state = { name:'', day:1, step:0, done:Array(9).fill(false), start_date:null, preview:false };
    snapshot = null; ui.nameInput.value = '';
    render(); showToast('Zresetowano.');
    return;
  }
  const inputName = ui.nameInput.value.trim();
  if(!inputName){ showToast('Podaj imię, aby rozpocząć.'); return; }
  // Wejście/zmiana osoby kończy podgląd i ładuje zapis danej osoby
  state.preview = false; snapshot = null; ui.peekBtn.classList.remove('active');
  load(inputName); if(!state.start_date) state.start_date = todayISO(); save(); render(); showToast(`Witaj, ${state.name}!`);
});

ui.prevBottom.addEventListener('click', prevStep);
ui.nextBottom.addEventListener('click', nextStep);

// Enter w polu imienia = start
ui.nameInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') ui.startBtn.click(); });

// Podgląd (X) — włącza swobodne przewijanie wszystkich dni, bez zapisu
ui.peekBtn.addEventListener('click', ()=>{
  if(state.preview){
    if(snapshot){ state = JSON.parse(snapshot); snapshot = null; }
    state.preview = false; ui.peekBtn.classList.remove('active');
    render(); showToast('Zakończono podgląd.');
  } else {
    snapshot = JSON.stringify(state);
    state.preview = true; ui.peekBtn.classList.add('active');
    if(!state.day) state.day = 1; if(!state.step) state.step = 0;
    render(); showToast('Podgląd wszystkich dni. Nawiguj strzałkami.');
  }
});

// ——— INIT ———
(function initTheme(){ const saved = localStorage.getItem(LS_THEME); if(saved){ setTheme(saved); } else { const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; setTheme(prefersDark? 'dark':'light'); } })();
render();

// ——— LISTA ZAPISANYCH IMION ———
function listProfiles(){
  const rows = [];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(!k || !k.startsWith(LS_PREFIX)) continue;
    try{
      const d = JSON.parse(localStorage.getItem(k) || '{}');
      const name = d.display_name || k.slice(LS_PREFIX.length);
      const start = d.start_date ? formatPL(parseISODate(d.start_date)) : '—';
      const doneCount = Array.isArray(d.done) ? d.done.filter(Boolean).length : 0;
      rows.push({name, start, doneCount});
    }catch(_){}
  }
  rows.sort((a,b)=> a.name.localeCompare(b.name, 'pl'));
  return rows;
}

function openNameMenu(){
  const rows = listProfiles();
  const menu = ui.nameMenu; if(!menu) return;
  if(rows.length===0){
    menu.innerHTML = '<div class="empty">Brak zapisanych imion. Zacznij od wpisania imienia i kliknij „Rozpocznij”.</div>';
  } else {
    const items = rows.map(r => `
      <div class="item" data-name="${r.name}">
        <div>
          <div><strong>${r.name}</strong></div>
          <div class="meta">start: ${r.start} • ukończone dni: ${r.doneCount}/9</div>
        </div>
        <button class="del" data-del="${r.name}">Usuń</button>
      </div>`).join('');
    menu.innerHTML = '<h4>Zapisane imiona</h4>' + items;
  }
  menu.classList.add('show');
  menu.setAttribute('aria-hidden','false');
}
function closeNameMenu(){ if(!ui.nameMenu) return; ui.nameMenu.classList.remove('show'); ui.nameMenu.setAttribute('aria-hidden','true'); }

ui.nameBtn.addEventListener('click', (e)=>{
  e.stopPropagation();
  if(ui.nameMenu.classList.contains('show')) closeNameMenu(); else openNameMenu();
});

document.addEventListener('click', (e)=>{
  if(!ui.nameMenu.classList.contains('show')) return;
  if(!ui.nameMenu.contains(e.target) && e.target !== ui.nameBtn) closeNameMenu();
});

ui.nameMenu.addEventListener('click', (e)=>{
  const del = e.target.closest('[data-del]');
  if(del){
    const n = del.getAttribute('data-del');
    if(n){ clearFor(n); if(state.name && state.name.toLowerCase()===n.toLowerCase()){ state = { name:'', day:1, step:0, done:Array(9).fill(false), start_date:null, preview:false }; render(); }
    openNameMenu(); showToast('Usunięto.'); }
    return;
  }
  const item = e.target.closest('.item');
  if(item){
    const n = item.getAttribute('data-name');
    if(n){ state.preview=false; if(ui.peekBtn) ui.peekBtn.classList.remove('active'); load(n); if(!state.start_date) state.start_date = todayISO(); save(); render(); showToast(`Witaj, ${state.name}!`); closeNameMenu(); }
  }
});

// ——— PROSTE TESTY (uruchamiane once, nie modyfikują stanu trwałego) ———
(function selfTests(){
  try{
    const snap = JSON.stringify(state);

    // Test 1: save() nie rzuca błędem składni (mock: ustaw nazwę i wyłącz preview)
    state.name = 'Test'; state.preview = false; state.start_date = todayISO();
    save();

    // Test 2: stepsForCurrent() — dla dnia 9 zwraca o 1 krok więcej (strona gratulacyjna)
    state.day = 9; const len9 = stepsForCurrent().length; if(len9 !== DAYS[8].length + 1) throw new Error('stepsForCurrent day9 length mismatch');

    // Test 3: render() nie psuje się bez imienia
    state.name = ''; render();

    // Test 4: isResetEligible — działa tylko na ostatniej stronie dnia 9
    state.name = 'Test'; state.day = 9; state.step = stepsForCurrent().length - 1; if(!isResetEligible()) throw new Error('isResetEligible should be true at last page of day 9');
    state.step = 0; if(isResetEligible()) throw new Error('isResetEligible should be false at step 1');

    // Test 5: preview NAWIGACJA — pozwala przejść z ostatniego kroku dnia do kolejnego dnia
    state.preview = true; state.day = 1; state.step = stepsForCurrent().length - 1; nextStep(); if(state.day !== 2) throw new Error('Preview nextStep should advance day');

    // Przywróć
    state = JSON.parse(snap); render();
    console.log('%cSelf-tests passed','color:green');
  }catch(e){ console.warn('Self-tests failed:', e); }
})();
</script>
</body>
</html>
