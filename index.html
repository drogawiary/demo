<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nowenna rozwiÄ…zujÄ…ca wÄ™zÅ‚y â€” interaktywnie (9 dni)</title>
<style>
  :root{
    --bg: #f3f6ff;
    --panel: #ffffff;
    --panel-2:#eef2ff;
    --text:#0e1533;
    --muted:#6370a0;
    --accent:#2450ff;
    --accent-2:#6ea8ff;
    --ring:#2450ff22;
    --ok:#2563eb;
    --ok-strong:#1d4ed8;
    --soft:#e8edff;
    --chip:#dbe5ff;
  }
  .dark{
    --bg:#0f1221;
    --panel:#161a2f;
    --panel-2:#1a1f3a;
    --text:#e8edff;
    --muted:#a7b1e6;
    --accent:#8ea0ff;
    --accent-2:#6ea8ff;
    --ring:#8ea0ff33;
    --ok:#8ea0ff;
    --ok-strong:#b2c2ff;
    --soft:#20254a;
    --chip:#272f63;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .wrap{max-width:800px; margin:0 auto; padding:18px;}
  header{display:block; margin-bottom:14px}
  .banner{background:linear-gradient(180deg,#cfe3ff,#e9f0ff); color:#0b2a55; border-radius:18px; padding:18px; text-align:center; box-shadow:0 8px 24px #0001; border:1px solid #ffffff70; margin-bottom:12px}
  .banner h1{margin:0; font-size:clamp(22px,4.5vw,32px); font-weight:800; letter-spacing:.2px}
  .controlbar{display:flex; align-items:center; justify-content:center; gap:10px; flex-wrap:wrap; position:relative}
  .menu{position:absolute; top:100%; margin-top:8px; background:var(--panel); border:1px solid #00000015; box-shadow:0 14px 40px #0003; border-radius:14px; padding:8px; min-width:220px; max-width:280px; z-index:50; display:none}
  .menu.show{display:block}
  .menu h4{margin:6px 8px 8px; font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.2px}
  .menu .item{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border-radius:10px; cursor:pointer}
  .menu .item:hover{background:var(--soft)}
  .menu .item .meta{font-size:11px; color:var(--muted)}
  .menu .del{border:none; background:#f1f3ff; color:#1a2a7a; border-radius:8px; padding:6px 8px; cursor:pointer}
  .menu .empty{padding:10px; font-size:12px; color:var(--muted)}
  .controls{display:flex; gap:8px; align-items:center;}
  .field{display:flex; gap:8px; align-items:center; background:var(--panel); border:1px solid #00000010; padding:6px 8px; border-radius:12px}
  .field input{border:none; outline:none; background:transparent; color:var(--text); font-size:14px; padding:6px; width:130px}
  .btn{border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700; letter-spacing:.2px}
  .toggle{background:var(--panel); border:1px solid #00000010; box-shadow:0 4px 14px #0002;}
  .square{width:40px; height:40px; padding:0; display:grid; place-items:center; background:#e7ebff; color:#1a2a7a}
  .square.active{background:#1a2a7a; color:#e7ebff}
  .start{background:linear-gradient(180deg, #35b86b, #2ea45f); color:white}
  .card{background:linear-gradient(180deg, var(--panel), var(--panel-2)); border:1px solid #ffffff12; border-radius:18px; padding:18px; box-shadow:0 10px 30px #0003}
  .content{min-height:120px; padding:14px; border-radius:14px; background:var(--soft); border:1px solid #ffffff22; line-height:1.6}
  .content h3{margin:0 0 10px; font-size:21px}
  .meta{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:10px; font-size:13px; color:var(--muted)}
  .ctrl-bottom{display:flex; align-items:center; justify-content:center; gap:10px; margin-top:10px; flex-wrap:wrap}
  .nav-btn{border:none; border-radius:999px; padding:12px 20px; background:#2450ff; color:white; font-weight:800; letter-spacing:.3px; cursor:pointer}
  .nav-btn:disabled{opacity:.5; cursor:not-allowed}
  .nav-btn.secondary{background:#d7dcef; color:#1c275f}
  .footer{margin-top:12px; display:flex; align-items:center; justify-content:center; gap:8px; white-space:nowrap; overflow-x:auto; padding:6px 4px}
  .dot{display:inline-block; width:18px; height:18px; border-radius:4px; background:#c9d3ff; border:1px solid #9bb1ff; opacity:.9}
  .dot.done{background:var(--ok); border-color:var(--ok-strong); opacity:1}
  .dot.current{background:var(--ok); border-color:var(--ok-strong); opacity:1}
  .toast{position:fixed; inset:auto 0 22px 0; display:flex; justify-content:center; pointer-events:none}
  .toast > div{background:#101940; color:white; padding:10px 16px; border-radius:12px; box-shadow:0 10px 30px #0007; opacity:0; transform:translateY(8px)}
  .toast.show > div{opacity:1; transform:translateY(0); transition:all .25s ease}
  .hint{font-size:12px; color:var(--muted); text-align:center; margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="banner"><h1>Nowenna rozwiÄ…zujÄ…ca wÄ™zÅ‚y</h1></div>
      <div class="controlbar">
        <button id="themeBtn" class="btn toggle" title="Tryb dzieÅ„ / noc">ğŸŒ/ğŸŒ™</button>
        <div class="field">
          <button id="nameBtn" class="btn square" title="Wybierz zapisane imiÄ™">ğŸ‘¤</button>
          <input id="nameInput" type="text" placeholder="np. Ania" maxlength="24" />
          <button id="startBtn" class="btn start">Start</button>
          <button id="peekBtn" class="btn square" title="PodglÄ…d wszystkich dni (X)">âœ•</button>
        </div>
        <div id="nameMenu" class="menu" aria-hidden="true"></div>
      </div>
    </header>

    <div class="card">
      <div id="content" class="content">Podaj imiÄ™ i kliknij â€Startâ€, aby zaczÄ…Ä‡ dzieÅ„ 1. Albo kliknij w ikonkÄ™ postaci, by wybraÄ‡ wczeÅ›niej zapisanych uÅ¼ytkownikÃ³w.</div>
      <div class="meta">
        <div id="metaDay">DzieÅ„ â€“</div>
        <div id="metaStep">Krok â€“/â€“</div>
      </div>

      <div class="ctrl-bottom">
        <button id="prevBottom" class="nav-btn secondary" disabled>âŸµ Wstecz</button>
        <button id="nextBottom" class="nav-btn" disabled>Dalej âŸ¶</button>
      </div>

      <div class="footer" id="footerDots"></div>
      <div class="hint">PostÄ™p nowenny â€” dzieÅ„ po dniu. âœ¦ Â© 2025 drogawiary@wp.pl</div>
    </div>
  </div>

  <div class="toast" id="toast"><div id="toastMsg">â€”</div></div>

<script>
'use strict';

// --- Bloki treÅ›ci uÅ¼ywane codziennie ---
const SEKWE = `
<h3>Sekwencja do Ducha ÅšwiÄ™tego</h3>
<p>PrzybÄ…dÅº, Duchu ÅšwiÄ™ty, zeÅ›lij z nieba wziÄ™ty Å›wiatÅ‚a Twego strumieÅ„...
<br/>Daj Twoim wierzÄ…cym, w Tobie ufajÄ…cym, siedmiorakie dary. Amen.</p>`;

const SKLAD = `
<h3>SkÅ‚ad Apostolski</h3>
<p>WierzÄ™ w Boga, Ojca wszechmogÄ…cego, Stworzyciela nieba i ziemi...
<br/>WierzÄ™ w Ducha ÅšwiÄ™tego... Å¼ywot wieczny. Amen.</p>`;

const AKT_ZALU = `
<h3>Akt Å¼alu</h3>
<p>BoÅ¼e mÃ³j, z caÅ‚ego serca Å¼aÅ‚ujÄ™ za wszystkie moje grzechy...
<br/>juÅ¼ wiÄ™cej nie grzeszyÄ‡ i na przyszÅ‚oÅ›Ä‡ unikaÄ‡ okazji do grzechu. Amen.</p>`;

const MODL_MARYJA = `
<h3>Modlitwa do Maryi RozwiÄ…zujÄ…cej WÄ™zÅ‚y</h3>
<p>Matko BoÅ¼a, ktÃ³ra rozwiÄ…zujesz wÄ™zÅ‚y... prowadÅº mnie do szczÄ™Å›cia wiecznego. Amen.</p>`;

// â€” PodziÄ™kowanie i ekrany koÅ„cowe â€”
const PODZIEKOWANIE_MARYI = `
<h3>PodziÄ™kowanie Maryi RozwiÄ…zujÄ…cej WÄ™zÅ‚y</h3>
<p>Maryjo, dziÄ™kujÄ™ Ci za TwojÄ… opiekÄ™ i wstawiennictwo. OddajÄ™ Tobie owoce tej modlitwy i proszÄ™, prowadÅº mnie dalej drogÄ… pokoju. Amen.</p>`;

const ZAKONCZ_DZIEN_INFO = `
<h3>UkoÅ„czyÅ‚eÅ› pierwszy dzieÅ„ nowenny</h3>
<p>Jutro, po zalogowaniu, otworzy siÄ™ <strong>kolejny dzieÅ„ nowenny</strong>. Kliknij <em>Dalej</em>, aby zakoÅ„czyÄ‡ dzieÅ„ i wrÃ³ciÄ‡ do poczÄ…tku.</p>`;

const ZAKONCZ_DZIEN_GENERIC = `
<h3>UkoÅ„czyÅ‚eÅ› ten dzieÅ„ nowenny</h3>
<p>Kliknij <em>Dalej</em>, aby wrÃ³ciÄ‡ do poczÄ…tku. Kolejny dzieÅ„ otworzy siÄ™ zgodnie z kalendarzem rozpoczÄ™cia.</p>`;

const ZAKONCZ_DZIEN_FINAL = `
<h3>UkoÅ„czyÅ‚eÅ› caÅ‚Ä… nowennÄ™</h3>
<p>NaciÅ›nij <em>Dalej</em> lub <em>Reset</em>, aby zakoÅ„czyÄ‡ nowennÄ™ i powrÃ³ciÄ‡ do strony startowej.<br/>
Niech Maryja prowadzi CiÄ™ dalej w codziennym Å¼yciu. ğŸŒ¿</p>`;

// --- Litania i modlitwa Å›w. Bernarda (skrÃ³t) ---
const LITANIA_LORETANSKA = `
<h3>Litania LoretaÅ„ska (skrÃ³t)</h3>
<p>ÅšwiÄ™ta Maryjo â€” mÃ³dl siÄ™ za nami.<br/>Matko BoÅ¼a â€” mÃ³dl siÄ™ za nami.<br/>KrÃ³lowo Pokoju â€” mÃ³dl siÄ™ za nami.<br/>Amen.</p>`;

const MODL_SW_BERNARDA = `
<h3>Modlitwa Å›w. Bernarda (Pomnij, o NajÅ›wiÄ™tsza Panno Maryjo)</h3>
<p>Pomnij, o NajÅ›wiÄ™tsza Panno Maryjo, Å¼e nigdy nie sÅ‚yszano, abyÅ› opuÅ›ciÅ‚a tego, kto siÄ™ do Ciebie ucieka... Matko SÅ‚owa Przedwiecznego, racz wysÅ‚uchaÄ‡, o Pani, i wysÅ‚uchaÄ‡ Å‚askawie. Amen.</p>`;

// --- Tajemnice rÃ³Å¼aÅ„ca: 3 pierwsze + 2 koÅ„cowe ---
const MYSTERIES = {
  radosne: {
    name: 'tajemnice radosne',
    first3: [
      {t:'Zwiastowanie', m:'ProÅ›my o gotowoÅ›Ä‡ przyjÄ™cia woli BoÅ¼ej jak Maryja.'},
      {t:'Nawiedzenie Å›w. ElÅ¼biety', m:'Ucz mnie sÅ‚uÅ¼by i wraÅ¼liwoÅ›ci na potrzeby innych.'},
      {t:'Narodzenie Pana Jezusa', m:'OddajÄ™ Ci moje domy i relacje â€” niech bÄ™dÄ… miejscem pokoju.'}
    ],
    last2: [
      {t:'Ofiarowanie w Å›wiÄ…tyni', m:'PrzynoszÄ™ Ci, Panie, moje plany i lÄ™ki o przyszÅ‚oÅ›Ä‡.'},
      {t:'Odnalezienie w Å›wiÄ…tyni', m:'OdnajdÅº mnie, gdy siÄ™ gubiÄ™; daj pragnienie Twojej mÄ…droÅ›ci.'}
    ]
  },
  bolesne: {
    name: 'tajemnice bolesne',
    first3: [
      {t:'Modlitwa w OgrÃ³jcu', m:'Ucz mnie mÃ³wiÄ‡: nie moja, lecz Twoja wola niech siÄ™ stanie.'},
      {t:'Biczowanie', m:'ZÅ‚Ä…cz moje cierpienia z Twoimi â€” uzdrÃ³w serce.'},
      {t:'Cierniem ukoronowanie', m:'Daj pokorÄ™, gdy spotyka mnie niesprawiedliwoÅ›Ä‡.'}
    ],
    last2: [
      {t:'DÅºwiganie krzyÅ¼a', m:'Ucz mnie wytrwaÅ‚oÅ›ci i miÅ‚oÅ›ci w trudnoÅ›ciach.'},
      {t:'ÅšmierÄ‡ na krzyÅ¼u', m:'Przebacz, jak Ty przebaczyÅ‚eÅ› â€” zwÅ‚aszcza najtrudniejszym.'}
    ]
  },
  chwalebne: {
    name: 'tajemnice chwalebne',
    first3: [
      {t:'Zmartwychwstanie', m:'OdnÃ³w mojÄ… nadziejÄ™ i radoÅ›Ä‡ wiary.'},
      {t:'WniebowstÄ…pienie', m:'UczyÅ„ mnie Å›wiadkiem Twojej miÅ‚oÅ›ci w codziennoÅ›ci.'},
      {t:'ZesÅ‚anie Ducha ÅšwiÄ™tego', m:'NapeÅ‚nij mnie darami Ducha dla sÅ‚uÅ¼by.'}
    ],
    last2: [
      {t:'WniebowziÄ™cie NMP', m:'Ucz mnie ufaÄ‡ jak Maryja, aÅ¼ do koÅ„ca.'},
      {t:'Ukoronowanie NMP', m:'Niech Maryja krÃ³luje w moim sercu i domu.'}
    ]
  },
  swiatla: {
    name: 'tajemnice Å›wiatÅ‚a',
    first3: [
      {t:'Chrzest w Jordanie', m:'DziÄ™kujÄ™ za moje powoÅ‚anie i chrzest â€” odnowisz we mnie Å‚askÄ™.'},
      {t:'Kana Galilejska', m:'Ulecz to, co sÅ‚abnie w miÅ‚oÅ›ci â€” przemieniaj wodÄ™ codziennoÅ›ci w wino Å‚aski.'},
      {t:'GÅ‚oszenie KrÃ³lestwa', m:'Daj mi nawrÃ³cenie serca i wiernoÅ›Ä‡ Ewangelii.'}
    ],
    last2: [
      {t:'Przemienienie', m:'RozjaÅ›nij moje decyzje Twoim Å›wiatÅ‚em.'},
      {t:'Eucharystia', m:'UczyÅ„ moje serce eucharystycznym: wdziÄ™czne i oddane.'}
    ]
  }
};

// â€” Indywidualne modlitwy dnia (dla kaÅ¼dego z 9 dni)
const DAILY_PRAYERS_BY_DAY = {
  1: `<h3>Modlitwa dnia â€” DzieÅ„ 1 (zawierzenie)</h3><p>Panie, oddajÄ™ Ci wszystkie wÄ™zÅ‚y mojego Å¼ycia. UczyÅ„ moje serce ufne i posÅ‚uszne Twojej woli, abym z pokorÄ… szedÅ‚ drogÄ…, ktÃ³rÄ… mi wyznaczasz. Amen.</p>`,
  2: `<h3>Modlitwa dnia â€” DzieÅ„ 2 (cierpliwoÅ›Ä‡)</h3><p>BoÅ¼e, ucz mnie cierpliwoÅ›ci w chwilach zwÄ…tpienia. Niech Twoje Å›wiatÅ‚o prowadzi mnie Å‚agodnie, a moje serce niech trwa w pokoju, gdy rozwiÄ…zania przychodzÄ… powoli. Amen.</p>`,
  3: `<h3>Modlitwa dnia â€” DzieÅ„ 3 (pojednanie)</h3><p>Jezu, pojednaj moje serce. Daj mi Å‚askÄ™ przebaczenia i odwagÄ™ proszenia o przebaczenie, aby miÅ‚oÅ›Ä‡ zwyciÄ™Å¼yÅ‚a urazy i nieporozumienia. Amen.</p>`,
  4: `<h3>Modlitwa dnia â€” DzieÅ„ 4 (mÄ…droÅ›Ä‡)</h3><p>Duchu ÅšwiÄ™ty, obdarz mnie mÄ…droÅ›ciÄ… w sprawach maÅ‚ych i wielkich. Niech Twoje Å›wiatÅ‚o rozjaÅ›ni moje decyzje i porzÄ…dkuje moje obowiÄ…zki. Amen.</p>`,
  5: `<h3>Modlitwa dnia â€” DzieÅ„ 5 (zaufanie)</h3><p>Ojcze, w Twoje rÄ™ce skÅ‚adam mojÄ… przyszÅ‚oÅ›Ä‡. Umocnij we mnie zaufanie, bym w kaÅ¼dych okolicznoÅ›ciach pamiÄ™taÅ‚, Å¼e prowadzisz mnie z miÅ‚oÅ›ciÄ…. Amen.</p>`,
  6: `<h3>Modlitwa dnia â€” DzieÅ„ 6 (zdrowie)</h3><p>Jezu, Lekarzu dusz i ciaÅ‚, powierzam Ci moje zdrowie i sÅ‚aboÅ›ci. Niech Twoja Å‚aska bÄ™dzie mojÄ… siÅ‚Ä… i pociechÄ…, a serce peÅ‚ne wdziÄ™cznoÅ›ci. Amen.</p>`,
  7: `<h3>Modlitwa dnia â€” DzieÅ„ 7 (przebaczenie)</h3><p>Panie, uczyÅ„ moje serce miÅ‚osiernym. Daj mi przebaczyÄ‡ tak, jak Ty przebaczasz â€” caÅ‚kowicie i bez powrotu do win. Amen.</p>`,
  8: `<h3>Modlitwa dnia â€” DzieÅ„ 8 (wytrwaÅ‚oÅ›Ä‡ i nadzieja)</h3><p>Maryjo, prowadÅº mnie drogÄ… wytrwaÅ‚oÅ›ci. Niech nadzieja zakorzeni siÄ™ gÅ‚Ä™boko we mnie i rodzi pokÃ³j w codziennoÅ›ci. Amen.</p>`,
  9: `<h3>Modlitwa dnia â€” DzieÅ„ 9 (wdziÄ™cznoÅ›Ä‡ i pokÃ³j serca)</h3><p>BoÅ¼e, dziÄ™kujÄ™ za wszelkie Å‚aski tej nowenny. Zachowaj we mnie pokÃ³j serca i naucz mnie Å¼yÄ‡ prostotÄ… i ufnoÅ›ciÄ… na kaÅ¼dy dzieÅ„. Amen.</p>`
};

const CLOSING_PRAYER = `<h3>Modlitwa na zakoÅ„czenie</h3><p>BoÅ¼e, ktÃ³ry przez MaryjÄ™ prowadzisz nas do Jezusa, pobÅ‚ogosÅ‚aw owoce tej modlitwy. Daj pokÃ³j mojemu sercu i umocnij w miÅ‚oÅ›ci. <strong>DziÄ™kujÄ™, Å¼e pozwoliÅ‚aÅ› mi odkryÄ‡ moc tej nowenny. Amen.</strong></p>`;

function mysteriesLinksHTML(){
  return `
  <h3>Trzy pierwsze dziesiÄ…tki rÃ³Å¼aÅ„ca (tajemnice z dnia)</h3>
  <p>Kliknij, aby przejÅ›Ä‡ do 3 pierwszych dziesiÄ…tkÃ³w z krÃ³tkimi rozwaÅ¼aniami; po nich bÄ™dzie modlitwa dnia, a nastÄ™pnie 2 koÅ„cowe dziesiÄ…tki, Litania LoretaÅ„ska, modlitwa Å›w. Bernarda i modlitwa na zakoÅ„czenie.</p>
  <ul>
    <li><a data-rosary='radosne' href='#tajemnice-radosne'>PoniedziaÅ‚ek â€“ radosne</a></li>
    <li><a data-rosary='bolesne' href='#tajemnice-bolesne'>Wtorek â€“ bolesne</a></li>
    <li><a data-rosary='chwalebne' href='#tajemnice-chwalebne'>Åšroda â€“ chwalebne</a></li>
    <li><a data-rosary='swiatla' href='#tajemnice-swiatla'>Czwartek â€“ Å›wiatÅ‚a</a></li>
    <li><a data-rosary='bolesne' href='#tajemnice-bolesne'>PiÄ…tek â€“ bolesne</a></li>
    <li><a data-rosary='radosne' href='#tajemnice-radosne'>Sobota â€“ radosne</a></li>
    <li><a data-rosary='chwalebne' href='#tajemnice-chwalebne'>Niedziela â€“ chwalebne</a></li>
  </ul>
  <p class='hint'>W Å›rodku uÅ¼ywaj przyciskÃ³w â€Wstecz/Dalejâ€.</p>`;
}

// --- Kroki dzienne â€” SZABLON I PEÅNE 9 DNI ---
function buildDay(intencje, {finalInfo=false} = {}){
  const arr = [
    ...intencje,
    mysteriesLinksHTML(),
    PODZIEKOWANIE_MARYI
  ];
  if(finalInfo===true){
    arr.push(ZAKONCZ_DZIEN_INFO);
  } else if(finalInfo==='generic'){
    arr.push(ZAKONCZ_DZIEN_GENERIC);
  } else if(finalInfo==='final'){
    arr.push(ZAKONCZ_DZIEN_FINAL);
  }
  return arr;
}

const DAYS = [
  buildDay([
    SEKWE, SKLAD, AKT_ZALU, MODL_MARYJA,
    'W imiÄ™ Ojca, Syna i Ducha ÅšwiÄ™tego â€” powierzam Ci, Panie, wszystkie wÄ™zÅ‚y mojego Å¼ycia.'
  ], { finalInfo:true }),

  buildDay([
    SEKWE, SKLAD, AKT_ZALU, MODL_MARYJA,
    'Panie, naucz mnie cierpliwoÅ›ci, gdy wÄ™zÅ‚y nie rozwiÄ…zujÄ… siÄ™ natychmiast.'
  ], { finalInfo:'generic' }),

  buildDay([SEKWE, SKLAD, AKT_ZALU, MODL_MARYJA, 'Zawierzam Ci relacje, w ktÃ³rych utknÄ…Å‚em w nieporozumieniach.'], { finalInfo:'generic' }),
  buildDay([SEKWE, SKLAD, AKT_ZALU, MODL_MARYJA, 'OddajÄ™ Ci, Panie, wÄ™zÅ‚y w pracy i obowiÄ…zkach.'], { finalInfo:'generic' }),
  buildDay([SEKWE, SKLAD, AKT_ZALU, MODL_MARYJA, 'Panie, dotknij moich lÄ™kÃ³w o przyszÅ‚oÅ›Ä‡.'], { finalInfo:'generic' }),
  buildDay([SEKWE, SKLAD, AKT_ZALU, MODL_MARYJA, 'Zawierzam Ci moje zdrowie â€” ciaÅ‚o i duszÄ™.'], { finalInfo:'generic' }),
  buildDay([SEKWE, SKLAD, AKT_ZALU, MODL_MARYJA, 'Panie, naucz mnie przebaczaÄ‡ â€” naprawdÄ™ i do koÅ„ca.'], { finalInfo:'generic' }),
  buildDay([SEKWE, SKLAD, AKT_ZALU, MODL_MARYJA, 'OdÅ‚Ã³Å¼ ode mnie pokusy zniechÄ™cenia i gniewu.'], { finalInfo:'generic' }),

  buildDay([
    SEKWE, SKLAD, AKT_ZALU, MODL_MARYJA,
    'DziÄ™kujÄ™ Ci, Panie, za wszystkie Å‚aski na tej drodze.'
  ], { finalInfo:'final' })
];

// --- UI refs i stan ---
const LS_THEME = 'nowenna_theme';
const LS_PREFIX = 'nowenna_wezly_';

const ui = {
  themeBtn: document.getElementById('themeBtn'),
  nameInput: document.getElementById('nameInput'),
  startBtn: document.getElementById('startBtn'),
  nameBtn: document.getElementById('nameBtn'),
  peekBtn: document.getElementById('peekBtn'),
  prevBottom: document.getElementById('prevBottom'),
  nextBottom: document.getElementById('nextBottom'),
  content: document.getElementById('content'),
  metaDay: document.getElementById('metaDay'),
  metaStep: document.getElementById('metaStep'),
  dotsWrap: document.getElementById('footerDots'),
  toast: document.getElementById('toast'),
  toastMsg: document.getElementById('toastMsg'),
  nameMenu: document.getElementById('nameMenu')
};

let state = {
  name: '',
  day: 1,
  step: 0,
  done: Array(9).fill(false),
  start_date: null,
  preview: false,
  rosary: null,
  lastRosaryType: null,
  fromRosaryExit: false
};
let snapshot = null;

function keyFor(name){ return LS_PREFIX + name.toLowerCase().trim(); }
function save(){
  if(!state.name) return;
  if(state.preview) return;
  localStorage.setItem(keyFor(state.name), JSON.stringify({
    display_name: state.name,
    day:state.day,
    step:state.step,
    done:state.done,
    start_date: state.start_date
  }));
}
function clearFor(name){ localStorage.removeItem(keyFor(name)); }
function load(name){
  const raw = localStorage.getItem(keyFor(name));
  if(!raw){ state = { ...state, name, day:1, step:0, done:Array(9).fill(false), start_date: todayISO(), preview:false, rosary:null }; return; }
  try{
    const d = JSON.parse(raw);
    state = {
      ...state,
      name: d.display_name || name,
      day: d.day||1,
      step: d.step||0,
      done: Array.isArray(d.done)? d.done.slice(0,9).concat(Array(9).fill(false)).slice(0,9) : Array(9).fill(false),
      start_date: d.start_date || todayISO(),
      preview:false,
      rosary:null
    };
  }catch(e){ state = { ...state, name, day:1, step:0, done:Array(9).fill(false), start_date: todayISO(), preview:false, rosary:null }; }
}

// --- Daty ---
function pad(n){ return String(n).padStart(2,'0'); }
function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function todayISO(){ const d = new Date(); return toISODate(new Date(d.getFullYear(), d.getMonth(), d.getDate())); }
function parseISODate(s){ const [y,m,da] = s.split('-').map(Number); return new Date(y, m-1, da); }
function formatPL(d){ return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`; }
function addDays(base, days){ const d = new Date(base.getTime()); d.setDate(d.getDate()+days); return d; }
function dateForDay(day){ if(!state.start_date) return null; const start = parseISODate(state.start_date); return addDays(start, day-1); }
function dayFromStart(){
  if(!state.start_date) return 1;
  const start = parseISODate(state.start_date);
  const today = parseISODate(todayISO());
  const diffMs = today - start;
  const days = Math.floor(diffMs / (24*60*60*1000));
  return Math.min(9, Math.max(1, days + 1));
}

function msUntilNextMidnight(){
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, 0,0,0,0);
  return next - now;
}
function syncDayToCalendar(){
  if(!state.name || state.preview) return;
  const idx = dayFromStart();
  if(state.day !== idx){ state.day = idx; state.step = 0; render(); }
}
let midnightTimer = null;
function scheduleMidnightSync(){
  if(midnightTimer){ clearTimeout(midnightTimer); clearInterval(midnightTimer); midnightTimer = null; }
  midnightTimer = setTimeout(()=>{
    syncDayToCalendar();
    midnightTimer = setInterval(syncDayToCalendar, 24*60*60*1000);
  }, msUntilNextMidnight());
}

// --- UI helpers ---
function setTheme(mode){ const root = document.documentElement; if(mode === 'dark') root.classList.add('dark'); else root.classList.remove('dark'); localStorage.setItem(LS_THEME, mode); }
function toggleTheme(){ const isDark = document.documentElement.classList.contains('dark'); setTheme(isDark? 'light' : 'dark'); }
function initTheme(){ const saved = localStorage.getItem(LS_THEME); if(saved){ setTheme(saved); } else { const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; setTheme(prefersDark? 'dark':'light'); } }

function updateStartButton(){
  if (isResetEligible()) { ui.startBtn.disabled = false; return; }
  ui.startBtn.disabled = !canStart();
}

function stepsForCurrent(){ return DAYS[state.day-1]; }

// â€” Pomocnicze
function hasRosaryForCurrentDay(){
  const steps = DAYS[state.day-1] || [];
  return steps.some(s => typeof s === 'string' && s.includes('data-rosary'));
}
function totalForDay(){
  const baseLen = (DAYS[state.day-1]||[]).length;
  return baseLen + (hasRosaryForCurrentDay() ? 9 : 0);
}
function rosaryLinkIndex(){
  const steps = DAYS[state.day-1] || [];
  for(let i=0;i<steps.length;i++){
    if(typeof steps[i]==='string' && steps[i].includes('data-rosary')) return i;
  }
  return -1;
}
function displayStepNumberForBaseStep(baseIdx){
  const linkIdx = rosaryLinkIndex();
  if(linkIdx === -1) return baseIdx + 1;
  if(baseIdx <= linkIdx) return baseIdx + 1;
  return baseIdx + 1 + 9;
}
function isRosarySelectionStep(){
  const steps = stepsForCurrent();
  const cur = steps[state.step];
  return (state.name || state.preview) && !state.rosary && typeof cur === 'string' && cur.includes('data-rosary');
}

function isResetEligible(){
  if(!state.name) return false;
  if(state.day!==9) return false;
  const steps = stepsForCurrent();
  return state.step === steps.length - 1;
}
function canStart(){
  const typed = ui.nameInput.value.trim();
  if(!typed) return false;
  if(state.name && typed.toLowerCase() === state.name.toLowerCase()) return false;
  return true;
}

// --- RÃ³Å¼aniec ---
function startRosary(type){
  state.lastRosaryType = type;
  state.rosary = { type, phase:'first3', index:0 };
  render();
}
function rosaryCurrentHTML(){
  const R = state.rosary;
  const pack = MYSTERIES[R.type];

  if(R.phase==='first3'){
    const cur = pack.first3[R.index];
    return `
      <h3>${pack.name} â€” dziesiÄ…tek ${R.index+1}/3</h3>
      <p><strong>${cur.t}</strong><br/>${cur.m}</p>
      <p class='hint'>OdmÃ³w: Ojcze nasz â€¢ 10Ã— ZdrowaÅ› Maryjo â€¢ ChwaÅ‚a Ojcu.</p>
    `;
  }
  if(R.phase==='dailyPrayer'){
    return DAILY_PRAYERS_BY_DAY[String(state.day)] || DAILY_PRAYERS_BY_DAY[state.day] || '<h3>Modlitwa dnia</h3><p>Panie, prowadÅº mnie dziÅ› i umacniaj w miÅ‚oÅ›ci. Amen.</p>';
  }
  if(R.phase==='last2'){
    const cur = pack.last2[R.index];
    return `
      <h3>${pack.name} â€” dziesiÄ…tek ${R.index+1}/2 (koÅ„cowe)</h3>
      <p><strong>${cur.t}</strong><br/>${cur.m}</p>
      <p class='hint'>OdmÃ³w: Ojcze nasz â€¢ 10Ã— ZdrowaÅ› Maryjo â€¢ ChwaÅ‚a Ojcu.</p>
    `;
  }
  if(R.phase==='litania'){ return LITANIA_LORETANSKA; }
  if(R.phase==='bernard'){ return MODL_SW_BERNARDA; }
  if(R.phase==='closing'){ return CLOSING_PRAYER; }
  return '';
}
function rosaryStageLabel(){
  if(!state.rosary) return '';
  const R = state.rosary; const pack = MYSTERIES[R.type];
  switch(R.phase){
    case 'first3': return `${pack.name} â€” dziesiÄ…tek ${R.index+1}/3`;
    case 'dailyPrayer': return `Modlitwa dnia (${pack.name})`;
    case 'last2': return `${pack.name} â€” dziesiÄ…tek ${R.index+1}/2 (koÅ„cowe)`;
    case 'litania': return 'Litania LoretaÅ„ska';
    case 'bernard': return 'Modlitwa Å›w. Bernarda';
    case 'closing': return 'Modlitwa na zakoÅ„czenie';
    default: return '';
  }
}
function bindRosaryLinks(){
  const links = ui.content.querySelectorAll('a[data-rosary]');
  links.forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const t = a.getAttribute('data-rosary');
      if(!t) return;
      startRosary(t);
    });
  });
}

// --- Render ---
function render(){
  updateStartButton();

  if(!state.name){
    ui.content.innerHTML = 'Podaj imiÄ™ i kliknij â€Startâ€, aby zaczÄ…Ä‡ dzieÅ„ 1. Albo kliknij w ikonkÄ™ postaci, by wybraÄ‡ wczeÅ›niej zapisanych uÅ¼ytkownikÃ³w.';
    ui.metaDay.textContent = 'DzieÅ„ â€“';
    ui.metaStep.textContent = 'Krok â€“/â€“';
  } else {
    if(state.rosary){
      ui.content.innerHTML = rosaryCurrentHTML();
      const d = dateForDay(state.day);
      const dateStr = d ? formatPL(d) : 'â€”';
      ui.metaDay.textContent = `DzieÅ„ ${state.day} z 9 â€” ${dateStr}`;
      ui.metaStep.textContent = `Krok â€¦ z ${totalForDay()}`;
    } else {
      const steps = stepsForCurrent();
      const safeStep = Math.max(0, Math.min(state.step, steps.length-1));
      state.step = safeStep;
      ui.content.innerHTML = steps[safeStep];
      const d = dateForDay(state.day);
      const dateStr = d ? formatPL(d) : 'â€”';
      ui.metaDay.textContent = `DzieÅ„ ${state.day} z 9 â€” ${dateStr}`;
      ui.metaStep.textContent = `Krok ${displayStepNumberForBaseStep(safeStep)} z ${totalForDay()}`;
    }
  }

  // Dots
  ui.dotsWrap.innerHTML = '';
  for (let i = 1; i <= 9; i++) {
    const dot = document.createElement('div');
    dot.className = 'dot';
    if (state.name || state.preview) {
      const isDone =
        !!(state.done[i - 1]) ||
        i < state.day ||
        (i === state.day && (state.step > 0 || !!state.rosary));
      if (isDone) dot.classList.add('done');
      if (i === state.day) dot.classList.add('current');
    }
    const dt = state.name ? dateForDay(i) : null;
    dot.title = state.name && dt ? `DzieÅ„ ${i} â€” ${formatPL(dt)}` : `DzieÅ„ ${i}`;
    ui.dotsWrap.appendChild(dot);
  }

  // Nawigacja
  const canNavigate = state.name || state.preview;
  const stepsArr = canNavigate ? stepsForCurrent() : null;
  const atFirst = !stepsArr || state.step===0;
  const atLast  = !stepsArr || state.step===stepsArr.length-1;
  const disablePrev = !canNavigate || (atFirst && !(state.preview && state.day>1));
  let disableNext = !canNavigate || (atLast  && !(state.preview && state.day<9));
  if(isRosarySelectionStep()) disableNext = true;

  // Ekrany koÅ„cowe â€” Next zawsze aktywny
  if (
    state.name && stepsArr && (
      stepsArr[state.step] === ZAKONCZ_DZIEN_INFO ||
      stepsArr[state.step] === ZAKONCZ_DZIEN_GENERIC ||
      stepsArr[state.step] === ZAKONCZ_DZIEN_FINAL
    )
  ){
    disableNext = false;
  }

  ui.prevBottom.disabled = disablePrev;
  ui.nextBottom.disabled = disableNext;

  // Start/Reset
  ui.startBtn.textContent = isResetEligible() ? 'Reset' : 'Start';

  // Linki rÃ³Å¼aÅ„ca
  if(!state.rosary && state.name){
    const s = stepsForCurrent();
    if(s[state.step] && s[state.step].includes('data-rosary')) bindRosaryLinks();
  }
}

// â€” Reset wewnÄ™trzny
function resetAll(){
  if(state.name){
    state.done[state.day-1] = true;
    save();
  }
  state = { name:'', day:1, step:0, done:Array(9).fill(false), start_date:null, preview:false, rosary:null, lastRosaryType:null, fromRosaryExit:false };
  snapshot = null;
  ui.nameInput.value = '';
  render();
}

// Minimalny toast
function showToast(msg){
  ui.toastMsg.textContent = msg;
  ui.toast.classList.add('show');
  setTimeout(()=> ui.toast.classList.remove('show'), 3600);
}

// --- Nawigacja ---
function nextStep(){
  if(state.rosary){
    const R = state.rosary;
    if(R.phase==='first3'){
      if(R.index<2){ R.index++; render(); return; }
      R.phase='dailyPrayer'; render(); return;
    }
    if(R.phase==='dailyPrayer'){ R.phase='last2'; R.index=0; render(); return; }
    if(R.phase==='last2'){
      if(R.index<1){ R.index++; render(); return; }
      R.phase='litania'; render(); return;
    }
    if(R.phase==='litania'){ R.phase='bernard'; render(); return; }
    if(R.phase==='bernard'){ R.phase='closing'; render(); return; }
    if(R.phase==='closing'){
      state.rosary = null;
      const steps = stepsForCurrent();
      if(state.step < steps.length-1){
        state.step += 1; state.fromRosaryExit = true; save(); render();
      } else {
        state.done[state.day-1] = true; save(); render();
      }
      return;
    }
  }

  const steps = stepsForCurrent();

  if(!state.preview && state.name && state.day === 1 && steps[state.step] === ZAKONCZ_DZIEN_INFO){
    resetAll(); return;
  }
  if(!state.preview && state.name && steps[state.step] === ZAKONCZ_DZIEN_GENERIC){
    resetAll(); return;
  }

  if(state.preview){
    if(state.step < steps.length-1){ state.step += 1; render(); return; }
    if(state.day < 9){ state.day += 1; state.step = 0; render(); return; }
    resetAll(); return;
  }

  if(!state.name) return;

  if(state.step < steps.length-1){
    state.step += 1; state.fromRosaryExit = false; save(); render(); return;
  }

  state.done[state.day-1] = true; save();
  if(state.day===9){ render(); } else { state.step = 0; render(); }
}

function prevStep(){
  if(state.rosary){
    const R = state.rosary;
    if(R.phase==='first3'){
      if(R.index>0){ R.index--; render(); return; }
      state.rosary = null;
      state.step = rosaryLinkIndex();
      render(); return;
    }
    if(R.phase==='dailyPrayer'){ R.phase='first3'; R.index=2; render(); return; }
    if(R.phase==='last2'){
      if(R.index>0){ R.index--; render(); return; }
      R.phase='dailyPrayer'; render(); return;
    }
    if(R.phase==='litania'){ R.phase='last2'; R.index=1; render(); return; }
    if(R.phase==='bernard'){ R.phase='litania'; render(); return; }
    if(R.phase==='closing'){ R.phase='bernard'; render(); return; }
    return;
  }
  if(!state.name) return;

  const linkIdx = rosaryLinkIndex();
  if (linkIdx !== -1 && state.step === linkIdx + 1 && state.lastRosaryType) {
    state.rosary = { type: state.lastRosaryType, phase:'closing', index:0 };
    render(); return;
  }

  if(state.step > 0){ state.step -= 1; state.fromRosaryExit = false; save(); render(); }
}

// â€”â€” PROSTE TESTY â€” WYÅÄ„CZONE W PRODUKCJI â€”â€”
(function selfTests(){ /* no-op */ })();

// â€” Czyszczenie profili testowych przy starcie â€”
function purgeTestProfiles(){
  const TEST_NAMES = ['test', 'user', 'x'];
  for(let i=0; i<localStorage.length; i++){
    const k = localStorage.key(i);
    if(!k || !k.startsWith(LS_PREFIX)) continue;
    try{
      const d = JSON.parse(localStorage.getItem(k) || '{}');
      const dn = String(d.display_name || '').toLowerCase().trim();
      if(TEST_NAMES.includes(dn)){
        localStorage.removeItem(k);
        i--;
      }
    }catch(_){ /* ignore */ }
  }
}

(function init(){
  initTheme();
  purgeTestProfiles();     // â¬… usuÅ„ stare â€Test/User/Xâ€, jeÅ›li byÅ‚y
  ui.themeBtn.addEventListener('click', toggleTheme);
  render();
  scheduleMidnightSync();
  document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') syncDayToCalendar(); });
})();
</script>
</body>
</html>
